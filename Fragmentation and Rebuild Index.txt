-- Fragmentation Of all table index

SELECT DB_NAME(PS.database_id) AS dbName,
S.name  AS SchemaName,
SUM(RW.user_seeks + RW.user_scans + RW.user_lookups)Reads , SUM(RW.user_updates)Writes,
O.name AS TableName,
b.name,
ps.avg_fragmentation_in_percent,
ps.page_count
FROM sys.dm_db_index_physical_stats (DB_ID(), NULL, NULL, NULL, Null) AS ps
INNER JOIN sys.dm_db_index_usage_stats  AS RW ON ps.OBJECT_ID = RW.OBJECT_ID AND ps.index_id = RW.index_id
INNER JOIN sys.indexes AS b ON ps.OBJECT_ID = b.OBJECT_ID AND ps.index_id = b.index_id
INNER JOIN sys.objects O  ON PS.object_id = O.object_id
INNER JOIN sys.schemas S ON S.schema_id = O.schema_id
WHERE  
--ps.avg_fragmentation_in_percent >= 10 -- Indexes having Fragmentation >=20
--AND 
--PS.index_type_desc IN ('CLUSTERED INDEX','NONCLUSTERED INDEX') AND -- Only get clustered and nonclustered indexes
b.is_hypothetical = 0 -- Only real indexes
AND O.type_desc = 'USER_TABLE' -- Restrict to user tables
--AND PS.page_count > 500 --- ignore tables less tha 64K
--AND PS.database_id = 6
group by
PS.database_id,S.name  ,O.name,b.name,ps.avg_fragmentation_in_percent,ps.page_count
ORDER BY ps.avg_fragmentation_in_percent DESC


--Rebuild script 

ALTER INDEX [INDEX_NAME] ON [TABLE_NAME]
 REBUILD PARTITION = ALL WITH ( PAD_INDEX  = OFF, 
STATISTICS_NORECOMPUTE  = OFF, 
 ALLOW_ROW_LOCKS  = ON, ALLOW_PAGE_LOCKS  = ON, 
ONLINE = OFF, SORT_IN_TEMPDB = ON )
GO


-----to check fragentation of a particular table------------------------------------

USE AdventureWorks2022;
GO
DBCC SHOWCONTIG ('[sk].[LoginTokens]','IX_sk_LoginTokens_UserId_Last');
GO

------another query to check fregmentaion of a particular table----------------------

SELECT DB_NAME(PS.database_id) AS dbName,
S.name  AS SchemaName,
SUM(RW.user_seeks + RW.user_scans + RW.user_lookups)Reads , SUM(RW.user_updates)Writes,
O.name AS TableName,
b.name,
ps.avg_fragmentation_in_percent,
ps.page_count
FROM sys.dm_db_index_physical_stats (DB_ID(), NULL, NULL, NULL, NULL) AS ps
INNER JOIN sys.dm_db_index_usage_stats  AS RW ON ps.OBJECT_ID = RW.OBJECT_ID AND ps.index_id = RW.index_id
INNER JOIN sys.indexes AS b ON ps.OBJECT_ID = b.OBJECT_ID AND ps.index_id = b.index_id
INNER JOIN sys.objects O  ON PS.object_id = O.object_id
INNER JOIN sys.schemas S ON S.schema_id = O.schema_id
WHERE  s.name+'.'+o.name = 'sk.LoginTokens' -------------------------------Metntion table name
--ps.avg_fragmentation_in_percent >= 10 -- Indexes having Fragmentation >=20
--AND 
--PS.index_type_desc IN ('CLUSTERED INDEX','NONCLUSTERED INDEX') -- Only get clustered and nonclustered indexes
AND b.is_hypothetical = 0 -- Only real indexes
AND O.type_desc = 'USER_TABLE' -- Restrict to user tables
--AND PS.page_count > 1000 --- ignore tables less tha 64K
--AND PS.database_id = 6
group by
PS.database_id,S.name  ,O.name,b.name,ps.avg_fragmentation_in_percent,ps.page_count
ORDER BY ps.avg_fragmentation_in_percent DESC


--sp_updatestats
	